<!DOCTYPE HTML>
<html>

        <head>
  <meta charset="utf-8">
  <meta name="description" content="simple description">
  <meta name="author" content="netrc">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Simple title </title>

  <meta name="author" content="netrc">

  <style type="text/css">
    body {
        background: #446655; /* fallback for old browsers */
        background: #16222A; /* fallback for old browsers */
        background: -webkit-linear-gradient(to left, #16222A , #3A6073); /* Chrome 10-25, Safari 5.1-6 */
        background: linear-gradient(to left, #16222A , #3A6073); /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+*/
    }
    body, html {
      font-family: sans-serif;
      color: #99BBBB;
    }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
</head>

<body>

  <h2> githubTiddly </h2>
  </p>
  <table>
    <tr>
      <td> username </td>  <td> <input id='username' autofocus> </td>
      <td> repo name </td>  <td> <input id='reponame'> </td>
      <td> PAT </td>  <td> <input id='PAT'> </td>
      <td> <button  onclick="saveAndGo()"> save </button> </td>
    </tr>
  </table>  
  <hr>
  <div id="gtConsole">

  </div>
  
<script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
  <script content="text/javascript">
  // TODO add warn element to show warnings; auto clear after 4 seconds
  var gtConsoleEl;
  var gtVal;
  const gtItemName = "gtVal";

  function initPage(){
      gtConsoleEl = document.getElementById("gtConsole");
      gtVal = JSON.parse(localStorage.getItem(gtItemName));
      if (gtVal) {
        //gtConsole(`got local storage: ${gtVal.username} ${gtVal.reponame} ${gtVal.PAT}`)
        document.getElementById("username").value = gtVal.username;
        document.getElementById("reponame").value = gtVal.reponame;
        document.getElementById("PAT").value = gtVal.PAT;
        doLoad(gtVal.username, gtVal.reponame, gtVal.PAT); 
      } else {
        gtConsole('no local storage vals');
      }
  }
  
  function saveAndGo() {
    console.log('saveAndGo');
    //gtConsole('starting');
    let username = document.getElementById("username").value;
    let reponame = document.getElementById("reponame").value;
    let PAT = document.getElementById("PAT").value;
    if (!username || username==="") {
      gtConsole('please enter user name');
      return;
    }
    if (!reponame || reponame==="") {
      gtConsole('please enter repo name');
      return;
    }
    if (!PAT || PAT==="") {
      gtConsole('please enter PAT');
      return;
    }
    gtConsole(`saving ${username}/${reponame}`);
    localStorage.setItem(gtItemName, JSON.stringify( {username: username, reponame: reponame, PAT: PAT} ) );
    doLoad(username, reponame, PAT);
  }

  function doRequest(url, opts) {
    return new Promise ( (resolve, reject) => {
      console.log(`dr: fetch ${url}`);
      fetch(url, opts).then( response => {
        if (response.status !== 200) {
          gtConsole(`fetch problem ... Status Code: ${response.status}`);
          reject(`fetch problem ... Status Code: ${response.status}`);
        }
        response.text().then( data => {
          resolve(data);
        });
      }).catch( err => {
        gtConsole(`other Fetch Error ${err}`);
        reject(`Fetch Error ${err}`);
      });
    });
  }

  function doLoad( username, reponame, PAT ) {
    const contentsUrl = `https://api.github.com/repos/${username}/${reponame}/contents/`;
    const contentsOpts = {
      headers: {
        'User-Agent': 'tiddly',
        'Authorization': 'Basic ' + btoa(`${username}:${PAT}`),
        'Accept': 'application/json'
      }
    };
    gtConsole(`doLoad for ${username}...${contentsUrl}`);
    doRequest(contentsUrl, contentsOpts).then( rawData => {
      const contents = JSON.parse(rawData);
      //gtConsole(`contents: ${rawData}`);
      const indexInfo = contents.find( f => f.name==="index.html" );
      if (!indexInfo) {
        gtConsole('failed to find index.html');
        return;
      }
      gtConsole(`found index.html size: ${indexInfo.size} sha: ${indexInfo.sha}`);
      doRequest(indexInfo.git_url, contentsOpts).then( rawData => {
        gtConsole(`...got raw response t: ${typeof(rawData)} length: ${rawData.length}  ${rawData.slice(0,32)}`);
        const indexObj = JSON.parse(rawData);
        gtConsole(`...got response object...`);
        const bodyHTML = atob(indexObj.content);
        gtConsole(`...body html ${bodyHTML.length}  ... ${bodyHTML.slice(0,48)}`);
        document.close();
        document.open();
        document.write(bodyHTML);
    }) // TODO catch

    }).catch( err => {
      gtConsole(`some error with the contents fetch`);
    });
  }

  function gtConsole( str ) {
    gtConsoleEl.innerHTML += `<p> ${(new Date()).toISOString().slice(11,23)} ${str} </p>`;
    //gtConsoleEl.innerHTML = "foo";
  }

  if (document.readyState == 'loading') {  // loading yet, wait for the event
    document.addEventListener('DOMContentLoaded', initPage);
  } else {  // DOM is ready!
   initPage();
  }
</script>  
</body>
</html>
  